rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for role-based access control
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    function isSales() {
      return isAuthenticated() && getUserRole() == 'sales';
    }
    
    function isDesigner() {
      return isAuthenticated() && getUserRole() == 'designer';
    }
    
    function isProduction() {
      return isAuthenticated() && getUserRole() == 'production';
    }
    
    function isInstallation() {
      return isAuthenticated() && getUserRole() == 'installation';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function canViewAmounts() {
      return isAdmin() || isSales();
    }
    
    // Users collection - Admin can manage all users, users can read their own profile
    match /users/{userId} {
      allow read: if isAuthenticated() && (isAdmin() || isOwner(userId));
      allow create: if isAdmin();
      allow update: if isAdmin() || (isOwner(userId) && !('role' in request.resource.data.diff(resource.data).affectedKeys()));
      allow delete: if isAdmin();
    }
    
    // Projects collection - Complex role-based access control
    match /projects/{projectId} {
      // Read permissions
      allow read: if isAuthenticated();
      
      // Create permissions - Only Admin and Sales can create projects
      allow create: if isAdmin() || isSales();
      
      // Update permissions based on project status and user role
      allow update: if isAuthenticated() && (
        // Admin can update everything
        isAdmin() ||
        
        // Sales can update their own projects if status is DNE
        (isSales() && resource.data.createdBy == request.auth.uid && resource.data.status == 'DNE') ||
        
        // Designer can update DNE projects to Production or Completed
        (isDesigner() && resource.data.status == 'DNE' && 
         request.resource.data.status in ['Production', 'Completed']) ||
        
        // Production can update Production projects to Installation
        (isProduction() && resource.data.status == 'Production' && 
         request.resource.data.status == 'Installation') ||
        
        // Installation can update Installation projects to Completed
        (isInstallation() && resource.data.status == 'Installation' && 
         request.resource.data.status == 'Completed')
      );
      
      // Delete permissions - Only Admin and project creator (if Sales)
      allow delete: if isAdmin() || (isSales() && resource.data.createdBy == request.auth.uid);
      
      // Field-level validation
      allow write: if validateProjectData();
    }
    
    // Project validation function
    function validateProjectData() {
      let data = request.resource.data;
      return (
        // Required fields
        data.keys().hasAll(['name', 'completionDate', 'status', 'createdBy']) &&
        
        // Valid status values
        data.status in ['DNE', 'Production', 'Installation', 'Completed'] &&
        
        // Name must be string and not empty
        data.name is string && data.name.size() > 0 &&
        
        // Amount validation (if present)
        (!('amount' in data) || (data.amount is number && data.amount >= 0)) &&
        
        // CreatedBy must match authenticated user (for new documents)
        (resource == null || data.createdBy == resource.data.createdBy) &&
        
        // Status transition validation
        validateStatusTransition()
      );
    }
    
    // Status transition validation
    function validateStatusTransition() {
      let oldStatus = resource != null ? resource.data.status : null;
      let newStatus = request.resource.data.status;
      
      return (
        // New documents can start with DNE
        (resource == null && newStatus == 'DNE') ||
        
        // Valid transitions
        (oldStatus == 'DNE' && newStatus in ['Production', 'Completed']) ||
        (oldStatus == 'Production' && newStatus in ['Installation', 'Completed']) ||
        (oldStatus == 'Installation' && newStatus == 'Completed') ||
        
        // Admin can make any transition
        isAdmin()
      );
    }
    
    // Complaints collection
    match /complaints/{complaintId} {
      // Anyone can read complaints
      allow read: if isAuthenticated();
      
      // Anyone can create complaints
      allow create: if isAuthenticated() && validateComplaintData();
      
      // Only Admin and complaint creator can update
      allow update: if isAuthenticated() && (
        isAdmin() || 
        resource.data.createdBy == request.auth.uid
      ) && validateComplaintData();
      
      // Only Admin can delete complaints
      allow delete: if isAdmin();
    }
    
    // Complaint validation function
    function validateComplaintData() {
      let data = request.resource.data;
      return (
        // Required fields
        data.keys().hasAll(['title', 'description', 'customerName', 'projectId', 'status', 'priority', 'createdBy']) &&
        
        // Valid status and priority values
        data.status in ['open', 'in-progress', 'resolved'] &&
        data.priority in ['high', 'medium', 'low'] &&
        
        // String fields validation
        data.title is string && data.title.size() > 0 &&
        data.description is string && data.description.size() > 0 &&
        data.customerName is string && data.customerName.size() > 0 &&
        
        // CreatedBy must match authenticated user (for new documents)
        (resource == null || data.createdBy == resource.data.createdBy)
      );
    }
    
    // Milestones collection
    match /milestones/{milestoneId} {
      // Read permissions - anyone can read
      allow read: if isAuthenticated();
      
      // Create permissions - Admin and Production can create milestones
      allow create: if isAuthenticated() && (isAdmin() || isProduction()) && validateMilestoneData();
      
      // Update permissions
      allow update: if isAuthenticated() && (
        // Admin can update everything
        isAdmin() ||
        
        // Production can update milestones
        isProduction() ||
        
        // Installation can update milestone status
        (isInstallation() && onlyStatusChanged())
      ) && validateMilestoneData();
      
      // Delete permissions - Only Admin and Production
      allow delete: if isAdmin() || isProduction();
    }
    
    // Check if only status field is being changed
    function onlyStatusChanged() {
      let changedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return changedKeys.hasOnly(['status', 'completedDate', 'updatedAt']);
    }
    
    // Milestone validation function
    function validateMilestoneData() {
      let data = request.resource.data;
      return (
        // Required fields
        data.keys().hasAll(['projectId', 'title', 'status', 'dueDate']) &&
        
        // Valid status values
        data.status in ['pending', 'in-progress', 'completed'] &&
        
        // String fields validation
        data.title is string && data.title.size() > 0 &&
        data.projectId is string && data.projectId.size() > 0
      );
    }
    
    // Statistics collection (read-only for most users)
    match /statistics/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // System logs (Admin only)
    match /logs/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Default deny rule for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
